<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Andrew" />


<title>Introduction to the Metropolis Algorithm</title>

<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Introduction to the Metropolis Algorithm</h1>
<h4 class="author">Andrew</h4>

</div>


<p>This is a quick description of one way to write the Metropolis algorithm in R.</p>
<p>The full code is here, with a description of each part below. The chunk below is ready to copy and paste for your own experiments!</p>
<pre class="r"><code># Helper function to create log likelihoods
make_likelihood &lt;- function(f = dpois){
  force(f)
  function(data, ...) sum(f(data, ..., log = TRUE))
}

## define likelihoods for our problem
poisson_loglike &lt;- make_likelihood(f = dpois)

normal_loglike &lt;- make_likelihood(f = dnorm)

## function to use these to calculate the value of the numerator in Bayes Formula
numerator &lt;- function(v, data = xs)  {
  poisson_loglike(data, lambda = exp(v)) + normal_loglike(v, mean = 1, sd = 2)
}

# proposal function to make new parameter values.
propose_new &lt;- function(x, sig_tune) rnorm(1, mean = x, sd = sig_tune)

# start value
metropolis &lt;- function(dataset,
                       n_samples,
                       tune_parameter,
                       start_value, 
                       numerator_function = numerator){
  chain &lt;- numeric(n_samples)
  chain[1] &lt;- 0.1
  
  for (i in 2:length(chain)){
    
    start &lt;- chain[i-1]
    
    new &lt;- propose_new(start, sig_tune = tune_parameter)
    
    r &lt;- exp(numerator_function(new, data = dataset) - 
               numerator_function(start, data = dataset))
    
    p_accept &lt;- min(1, r)
    
    chain[i] &lt;- ifelse(runif(1) &lt; p_accept, new, start)
  }
  return(chain)
}</code></pre>
<div id="using-this-function-and-visualizing-the-results" class="section level2">
<h2>Using this function and visualizing the results</h2>
<pre class="r"><code>set.seed(1859)
xs &lt;- rpois(5, 27)

chain &lt;- metropolis(dataset = xs, n_samples = 5000, tune_parameter = 0.2, start_value = 0)

plot(exp(chain))</code></pre>
<p><img src="metropolis_example_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>When we visualize the chain to see the samples, we see what we hope to find: the sampler is bouncing around, drawing samples from the entire posterior.</p>
<p>Note at the beginning the sampler has to first “travel” to find the right range of values. These samples are not part of our answer, and aren’t useful to us. This is why we often drop the first few samples; these are known as the “burn-in” samples.</p>
<pre class="r"><code>set.seed(1859)
xs &lt;- rpois(5, 27)

plot(exp(chain[300:5000]), type = &quot;l&quot;)</code></pre>
<p><img src="metropolis_example_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>This is a very common way of visualizing the posterior samples; this is called the “trace plot”. You want it to look like this: a “fuzzy caterpillar”. This means that the sampler is moving around the posterior easily, and not getting stuck in a particular zone.</p>
<div id="question-why-do-we-transform-our-chain-with-exp" class="section level3">
<h3>Question: why do we transform our chain with <code>exp()</code>?</h3>
<p>In our model we applied the log link to the mean of the poisson distribution. Look back at our function called <code>numerator</code>, which calculates the likelihood times the prior. You’ll see that we are estimating the posterior for <code>a</code>, which is the <em>exponent</em> on <span class="math inline">\(\lambda\)</span>.</p>
<p>Our model is:</p>
<p><span class="math display">\[
\begin{align}
y &amp;\sim \text{Poisson}(e^{a}) \\
a &amp;\sim \text{Normal}(1, 2) 
\end{align}
\]</span></p>
<p>Our chain samples are for the parameter <span class="math inline">\(a\)</span>. So if we want the posterior distribution of the <em>mean</em> of the Poisson, we need to use <code>exp</code> to transform our chain.</p>
</div>
</div>
<div id="comparing-to-the-conjugate" class="section level2">
<h2>Comparing to the conjugate</h2>
<p>We have a very straightforward way of checking our work: we can calculate the conjugate posterior for our chain and compare that to our samples:</p>
<p>First we need to imagine a new model, with a different prior:</p>
<p><span class="math display">\[
\begin{align}
y &amp;\sim \text{Poisson}(\lambda) \\
\lambda &amp;\sim \text{Gamma}(25^2/15^2, 25/15^2) 
\end{align}
\]</span></p>
<p>The prior looks like this:</p>
<pre class="r"><code>curve(dgamma(x, (25/15)^2, 25/15^2), xlim = c(1, 50))</code></pre>
<p><img src="metropolis_example_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>And here is the comparison of the two:</p>
<pre class="r"><code># plot of the prior

# plot of chain samples
plot(density(exp(chain[250:5000])), ylim = c(0,.3), lty = 2, lwd = 2,
     main = &quot;Posterior samples compared to conjugate posterior&quot;)

# plot of prior
curve(dgamma(x, (25/15)^2 + sum(xs),
             25/15^2 + length(xs)),
      xlim = c(1, 50),
      add = TRUE, lwd = 2, col = &quot;green&quot;)</code></pre>
<p><img src="metropolis_example_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>And the match is pretty close!</p>
</div>
<div id="breaking-down-the-code" class="section level2">
<h2>Breaking down the code</h2>
<div id="define-likelihoods-and-priors" class="section level3">
<h3>Define likelihoods and priors</h3>
<pre class="r"><code># Helper function to create likelihoods
make_likelihood &lt;- function(f = dpois){
  force(f)
  function(data, ...) sum(f(data, ..., log = TRUE))
}</code></pre>
<p>This function is the gnarly part. This is a function that takes a function and <em>returns another function</em>. In this case, we give <code>make_likelihood()</code> a probability density function, like <code>dnorm</code>, <code>dpois</code>, <code>dlnorm</code> etc. The output is a function that will calculate the log-likelihood using that distribution.</p>
<p>For example, we can make a function to calculate the likelihood of some data using the Poisson distribution.</p>
<pre class="r"><code>poisson_loglike &lt;- make_likelihood(dpois)</code></pre>
<p>In this example, <code>poisson_loglike()</code> is a new function. It has two arguments:</p>
<ol style="list-style-type: decimal">
<li><code>data</code>, which is a vector of observations we want to use to calculate the log likelihood.</li>
<li><code>...</code> which means “any arguments that the distribution function needs”. Some will only need one argument (e.g. <code>dpois()</code> needs only <code>lambda</code>) an others would need two or more (for example <code>dnorm()</code> needs <code>mean</code> and <code>sd</code>)</li>
</ol>
<p>Experiment to convince yourself that this function does what you expect</p>
<pre class="r"><code>poisson_loglike(xs, lambda = 5)</code></pre>
<pre><code>## [1] -98.31556</code></pre>
<pre class="r"><code>poisson_loglike(xs, lambda = 6)</code></pre>
<pre><code>## [1] -82.53091</code></pre>
<pre class="r"><code>poisson_loglike(xs, lambda = 9)</code></pre>
<pre><code>## [1] -51.30788</code></pre>
<pre class="r"><code>poisson_loglike(xs, lambda = 30)</code></pre>
<pre><code>## [1] -19.05498</code></pre>
<p>We can even use this function to perform a simple grid search for lambda:</p>
<pre class="r"><code>values_of_lambda &lt;- seq(5,50, length.out = 100)

ll_pois &lt;- sapply(values_of_lambda, function(x) poisson_loglike(data = xs, lambda = x))

plot(values_of_lambda, ll_pois)</code></pre>
<p><img src="metropolis_example_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>This hopefully helps you to see that this function accomplishes the same thing as our earlier work on likelihoods.</p>
<pre class="r"><code>normal_loglike &lt;- make_likelihood(f = dnorm)

normal_loglike(5, mean = 10, sd = 2)</code></pre>
<pre><code>## [1] -4.737086</code></pre>
<p>The next step creates another likelihood generating function. This time the <em>input</em> is only one number. We’re going to use this function to calculate the likelihood of proposals according to the <em>prior</em>, so we are testing only one number every time. <code>normal_loglike()</code> still contains a sum, but since there is only one number the output is the exact same as using <code>dnorm(5, mean = 10, sd = 2, log = TRUE)</code></p>
<pre class="r"><code>normal_loglike(5, mean = 10, sd = 2)</code></pre>
<pre><code>## [1] -4.737086</code></pre>
<pre class="r"><code>dnorm(5, mean = 10, sd = 2, log = TRUE)</code></pre>
<pre><code>## [1] -4.737086</code></pre>
</div>
<div id="combine-likelihood-and-prior-to-make-the-numerator" class="section level3">
<h3>Combine likelihood and prior to make the numerator</h3>
<pre class="r"><code>## function to use these to calculate the value of the numerator in Bayes Formula
numerator &lt;- function(v, data = xs)  {
  poisson_loglike(data, lambda = exp(v)) + normal_loglike(v, mean = 1, sd = 2)
}</code></pre>
<p>This <code>numerator()</code> function adds together the log-likelihood of the data and the prior, calculated for some value <code>v</code>.</p>
</div>
<div id="proposal-function" class="section level3">
<h3>Proposal function</h3>
<p>Finally we need a <em>proposal function</em>. This takes the current value and returns a proposition.</p>
<pre class="r"><code>propose_new &lt;- function(x, sig_tune) rnorm(1, mean = x, sd = sig_tune)</code></pre>
<p>We can check this one to make sure it works as we intend</p>
<pre class="r"><code>propose_new(10, sig_tune = 2)</code></pre>
<pre><code>## [1] 10.16376</code></pre>
<pre class="r"><code>propose_new(10, sig_tune = 2)</code></pre>
<pre><code>## [1] 10.80047</code></pre>
<pre class="r"><code>propose_new(10, sig_tune = 2)</code></pre>
<pre><code>## [1] 9.108949</code></pre>
<pre class="r"><code>propose_new(10, sig_tune = 2)</code></pre>
<pre><code>## [1] 11.83946</code></pre>
<p>The larger <code>sig_tune</code> the farther the new value will be from the old one.</p>
</div>
<div id="run-the-chain" class="section level3">
<h3>Run the chain</h3>
<p>Now we just need to generate proposals and decide wether to accept or reject them. We do this by generating a proposal, then apply the numerator function to the proposal and the original value, then calculating the acceptance probability.</p>
<pre class="r"><code>chain &lt;- numeric(500)


chain[1] &lt;- 0.1

for (i in 2:length(chain)){

  start &lt;- chain[i-1]

  new &lt;- propose_new(start, 0.1)

  r &lt;- exp(numerator(new) - numerator(start))

  p_accept &lt;- min(1, r)

  chain[i] &lt;- ifelse(runif(1) &lt; p_accept, new, start)
}

plot(exp(chain))</code></pre>
<p><img src="metropolis_example_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
